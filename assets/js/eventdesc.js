var APIToken = "ZK55TMREDURZKUJDZZ64"
var googleMapAPI = "AIzaSyBuMQJedJWyxzXaIQkMRnuwXzh-W75MyWU"
var likeBtn = document.getElementById("like-btn")
var backBtn = document.getElementById("back-btn")
var backBtnText = document.getElementById("back-btn-text")


// Grab evrnt id from url query string
// !!! Dependency on href link from Event Main Page. href should be ./index.html?event=" + eventid

var getEventId = function() {

    var queryString = document.location.search;
    var eventId = queryString.split("=")[1];
  
    return eventId
};

// Generate Liked status,
// If the page goes from saved list and then the icon and button text should be in "liked" button
// If the pages goes from event main page, then the icon and button should be in default values "like"
var genHeader = function () {
    var checkEvent = JSON.parse(localStorage.getItem("savedlist"))
    var likeIconEl = document.getElementById("like-icon")
    var likeBtnEl = document.getElementById("like-btn")
    

    if (checkEvent == null) {
        return
    }
    else {
        var foundEvent = checkEvent.some(el => el.event_id == getEventId());
        if (foundEvent) {
            likeIconEl.className = "fa fa-heart"
            likeBtnEl.setAttribute("like-value", "liked")
            likeBtnEl.textContent = "Liked"
        }
        else {
            return
        }
    }


}

genHeader();

var eventId = getEventId()

// For test purpose
var testevent = "335539506697"

// Get event symmary from API, public fields
// Replace testevent by eventId
var getEventDetails = function() {
    
    var eventApiUrl = "https://www.eventbriteapi.com/v3/events/" + testevent   + "/?token=" + APIToken

    return fetch (eventApiUrl)
    .then (function (response) {
        if (response.ok) {              
            return response.json()
        }
        else {
            alert('Error: Event Not Found');
          }
    })
    .then(function(data) {
        var eventDetails={
            "event_id": data.id,
            "summary": data.summary,
            "logo_img": data.logo.url,
            "title": data.name.text,
            "time": moment(data.start.local).format('MMMM Do YYYY, h:mm:ss a'),
            "location_id": data.venue_id
        }
        return eventDetails
    })
    .catch(function(error) {
        alert("Unable to connect to API");
      });
}

// Get location details, including longitude and latitude for Google Map API
// Venues fields are expansion, can't be generated by initial API call
var getLocationGeo = function() {

    return getEventDetails()
    .then(function(eventDetails) {

        var eventVenueUrl =  "https://www.eventbriteapi.com/v3/" + "venues/"  + eventDetails.location_id + "/?token=" + APIToken
        return fetch(eventVenueUrl)
        .then (function (response) {
            if (response.ok) {              
                return response.json()
            }
            else {
                alert('Error: Event Not Found');
              }
        })
        .then(function(data) {
            var eventLocation = {
                "address": data.address.localized_address_display,
                "location_name": data.name,
                "lat": data.latitude,
                "lon": data.longitude
            }
            console.log(eventLocation)

            return eventLocation
        })

    .catch(function(error) {
        alert("Unable to connect to API");
    });
    }
    )
}


// Get price details, price fields are in expansion, can't generate from initial api call
var getTicketPrice = function() {

    var priceApiUrl = "https://www.eventbriteapi.com/v3/events/" + testevent + "/ticket_classes"   + "/?token=" + APIToken

    return fetch (priceApiUrl)
    .then (function (response) {
        if (response.ok) {              
            return response.json()
        }
        else {
            alert('Error: Event Not Found');
          }
    })
    .then(function(data) {
        console.log(data)

        var ticketArray = data.ticket_classes

        var keysToKeep = ["cost", "category", "display_name", "on_sale_status"]
        var redux = array => array.map(o => keysToKeep.reduce((acc, curr) => {
            acc[curr] = o[curr];
            return acc;
        }, {}));

        var ticketDetailsArray = redux(ticketArray) 

        for (i = 0; i < ticketDetailsArray.length; i++) {
            (function(i) {
                if(ticketDetailsArray[i].cost == null) {
                    ticketDetailsArray[i].cost = "$0"
                }
                else {
                    var extrCost = ticketDetailsArray[i].cost.display
                    ticketDetailsArray[i].cost = extrCost
                }
            } (i))
        }

       var priceDetails = {
        "price" : ticketDetailsArray
       }

       console.log(priceDetails)
       return priceDetails
    })
    .catch(function(error) {
        alert("Unable to connect to API");
      });
}

// Get Full description, can't get from initial call, need to call structued_content
var getFullDesc = function() {
    
    var descApiUrl = "https://www.eventbriteapi.com/v3/events/" + testevent + "/structured_content"   + "/?token=" + APIToken

    return fetch (descApiUrl)
    .then (function (response) {
        if (response.ok) {              
            return response.json()
        }
        else {
            alert('Error: Event Not Found');
          }
    })
    .then(function(data) {
        console.log(data)
        var eventFullDesc = {
            "fulldesc": data.modules[0].data.body.text.replace("<p>", "").replace("</p>", "")
        }

        return eventFullDesc
    })
    .catch(function(error) {
        alert("Unable to connect to API");
      });
}


// Combine event details in single array
var comDetails = function () {

    return getEventDetails()
    .then(function(eventDetails) {
        return getLocationGeo()
        .then(function(eventLocation) {
            return getFullDesc()
            .then(function(eventFullDesc) {
                return getTicketPrice()
                .then(function(priceDetails) {

                var eventDetailsArray = Object.assign(eventDetails,eventLocation,eventFullDesc,priceDetails)
                console.log(eventDetailsArray)
                return eventDetailsArray
            })
            }
        )
    })
})
}

// Generate and display the event details on webpage
var eventMainEl = document.getElementById("event-main")
genPage = function () {

    return comDetails()
    .then(function(eventDetailsArray) {
        console.log(eventDetailsArray)
        var eventSummary = document.createElement("section")
        eventSummary.className = "event-summary"

        var imgSec = document.createElement("img")
        imgSec.className = "event-img"
        imgSec.src = eventDetailsArray.logo_img

        var eventDetailsMain = document.createElement("section")
        eventDetailsMain.className = "event-details-main"
        var eventName = document.createElement("h1")
        eventName.innerHTML = eventDetailsArray.title
        var eventDate = document.createElement("p")
        eventDate.className = "event-date"
        eventDate.innerHTML = eventDetailsArray.time
        var eventLocation = document.createElement("p")
        eventLocation.className = "event-location"
        eventLocation.innerHTML = eventDetailsArray.location_name
        var eventAddress = document.createElement("p")
        eventAddress.className = "event-address"
        eventAddress.innerHTML = eventDetailsArray.address

        eventDetailsMain.appendChild(eventName)
        eventDetailsMain.appendChild(eventDate)
        eventDetailsMain.appendChild(eventLocation)
        eventDetailsMain.appendChild(eventAddress)

        eventSummary.appendChild(imgSec)
        eventSummary.appendChild(eventDetailsMain)

        var eventPriceMain = document.createElement("section")
        eventPriceMain.className = "price-section"
        var eventPriceHeader = document.createElement("h2")
        eventPriceHeader.innerHTML = "Price"

        var eventPriceLi = document.createElement("ul")
        eventPriceLi.className = "event-price-main"
        eventPriceLi.style = "list-style: none;"
        for (j=0; j <eventDetailsArray.price.length; j++) {
            (function(j) {
                var eventPriceEl = document.createElement("li")
                eventPriceEl.className = "price-detail"
                var eventPriceCost = document.createElement("p")
                eventPriceCost.innerHTML = "Price: " + eventDetailsArray.price[j].cost
                var eventPriceName = document.createElement("p")
                eventPriceName.innerHTML = "Category: " + eventDetailsArray.price[j].display_name
                var eventPriceStatus = document.createElement("p")
                eventPriceStatus.innerHTML = "Status: " + eventDetailsArray.price[j].on_sale_status

                eventPriceEl.appendChild(eventPriceCost)
                eventPriceEl.appendChild(eventPriceName)
                eventPriceEl.appendChild(eventPriceStatus)

                eventPriceLi.appendChild(eventPriceEl)
            }(j))
        }

        eventPriceMain.appendChild(eventPriceHeader)
        eventPriceMain.appendChild(eventPriceLi)

        var eventDescription = document.createElement("section")
        eventDescription.className = "event-desc-main"
        var eventDescHeader = document.createElement("h2")
        eventDescHeader.innerHTML = "About this event"
        var eventDescDetails = document.createElement("p")
        eventDescDetails.innerHTML = eventDetailsArray.summary
        eventDescDetails.className = "event-desc-summary"
        var eventFullDescs = document.createElement("P")
        eventFullDescs.innerHTML = eventDetailsArray.fulldesc

        eventDescription.appendChild(eventDescHeader)
        eventDescription.appendChild(eventDescDetails)
        eventDescription.appendChild(eventFullDescs)

        eventMainEl.appendChild(eventSummary)
        eventMainEl.appendChild(eventPriceMain)
        eventMainEl.appendChild(eventDescription)
    }

    )
}

genPage()

// Initialize and add the map
function initMap() {     
    return comDetails()
    .then(function(eventDetailsArray) {
        // The location of event
        const eventLoc = { lat: parseFloat(eventDetailsArray.lat), lng: parseFloat(eventDetailsArray.lon) };
        console.log(eventLoc)
        
        const map = new google.maps.Map(document.getElementById("map"), {
        zoom: 11,
        center: eventLoc
        });
        
        // The marker, positioned at event location
        const marker = new google.maps.Marker({
            position: eventLoc,
            map: map,
        });
        }
    )
}

window.initMap = initMap;


var savedEventArray = []

// Add event listener on Like button
// If click "Like", heart icon turns into solid color, and button text turns into "Liked"
// If click again, heart icon turns back to default color(transparent with border), and button text turns back to default text("Like")
// If this webpage is directed from savedlist webpage, then change the default "like" status to "liked" status
// If this webpage is directed from event main webpage, then do nothing.
// Save the liked events to local storage
likeBtn.addEventListener("click", function(event){

    var savedList = null 
    event.preventDefault();
    var likeIcon = document.getElementById("like-icon")
    var likeValue = likeBtn.getAttribute("like-value")

    savedList = JSON.parse(localStorage.getItem("savedlist"))

    if (likeValue == "like") {
        likeIcon.className = "fa fa-heart"
        this.textContent = "Liked"
        this.setAttribute("like-value", "liked")

        return comDetails()
        .then(function(eventDetailsArray) {
            
            if (savedList == null) {
                savedEventArray.push(eventDetailsArray)
                localStorage.setItem("savedlist", JSON.stringify(savedEventArray))
            }
            else {
                
                savedList.push(eventDetailsArray)
                localStorage.setItem("savedlist", JSON.stringify(savedList))
            }
            }
        )
        }

    else {
        likeIcon.className = "fa fa-heart-o"
        this.textContent = "Like"
        this.setAttribute("like-value", "like")

        return comDetails()
        .then(function(eventDetailsArray) {
            if (savedList == null || savedList.length == 0) {
                return
            }
            else {
                var newlist = savedList.filter(data => data.event_id != eventDetailsArray.event_id);
                localStorage.setItem("savedlist", JSON.stringify(newlist))
            }
            }
        )
        }
    }
)

// Add event listener on Back Button
// !!! Dependency on local storage of Event Main Page
// !!! Pay attention that not directly link back to Event Main Page, need to link back to "selected"/"already loaded" Event Main Page
backBtn.addEventListener("click", function(event) {

    event.preventDefault();
    backBtnText.setAttribute("href", "")

}

)
